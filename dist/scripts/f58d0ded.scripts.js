"use strict";var ServiceConfig={api:"http://api.photomap.me/"};angular.module("photomapApp",["ngCookies","ngResource","ngSanitize","ngRoute","ui-rangeSlider","angularFileUpload","uiGmapgoogle-maps","ngGeolocation"]).config(["uiGmapGoogleMapApiProvider",function(a){a.configure({v:"3.17",libraries:"weather,geometry,visualization"})}]).config(function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/upload",{templateUrl:"views/upload.html",controller:"UploadCtrl"}).when("/register",{templateUrl:"views/register.html",controller:"RegisterCtrl"}).when("/login",{templateUrl:"views/login.html",controller:"LoginCtrl"}).when("/pictures",{templateUrl:"views/pictures.html",controller:"PicturesCtrl"}).otherwise({redirectTo:"/"})}),angular.module("photomapApp").controller("MainCtrl",["$scope","Pictures","uiGmapGoogleMapApi","$cookieStore","$geolocation",function(a,b,c,d,e){function f(c,e){c&&e&&b.getPicturesInRange(c,e,function(b,c){var e,f;if(d){var g=d.get("session");g&&(e=g.sessionId,f=g.userId)}a.markers=[],console.log("total pics ",c.length);for(var h=c.length>30?30:c.length,i=0;h>i;i++){var j=c[i];a.markers.push({latitude:j.lonlat[1],longitude:j.lonlat[0],title:j.name,year:j.year,lon:j.lonlat[0],lat:j.lonlat[1],thumb:ServiceConfig.api+"picture?file="+j.name+"&sessid="+e+"&userid="+f,id:i,date:moment.utc(j.timestamp,"X").format("YYYY-MM-DD"),show:!1,options:{content:"test"+i},handleMarkerClick:function(a,b,c){console.log("I was clicked",c),c.show=!c.show}})}})}function g(){i||(i=a.years.max);var b=i+"/"+n+"/30";console.log("to year",b);var c=moment(b);k=c.endOf("month"),k=k.unix(),console.log("to date ",k)}function h(){var a=l+"/"+m+"/01";console.log("from date ",a),j=moment(a).unix(),console.log("from date ",j)}e.getCurrentPosition().then(function(b){a.location=b}),a.map={center:{latitude:52,longitude:-7.2},zoom:2},a.$watch("location",function(b){console.log("position changed",b),b&&(a.map={center:{latitude:b.coords.latitude,longitude:b.coords.longitude},zoom:7})},!0),a.markers=[],a.years={min:Number(1990),max:Number(2015)},a.quantity=7,a.months={min:1,max:12,from:1,to:moment().get("month")+1},b.getYearRange(function(b,c){return b?void console.log("err ",b):(c.sort(),console.log("range",c),void(c.length>0&&(a.years={min:Number(c[0]),max:Number(c[c.length-1]),from:Number(c[0]),to:Number(c[c.length-1])})))});var i,j,k,l=2011,m=1,n=12;a.markerControl={},a.thumbClick=function(){console.log("clicked ",this.$index,a.markerControl.getPlurals());var b=a.markerControl.getPlurals().get(this.$index);console.log(b),new google.maps.event.trigger(b.gObject,"click"),a.map.center.latitude=b.clonedModel.latitude,a.map.center.longitude=b.clonedModel.longitude,a.map.zoom=10},a.$watch("years.from",function(){if(console.log("hey, myVar has changed!",this),this.last){var a=l;if(l=this.last,Number(a)===Number(l))return;console.log("from year changed requesting pics ",a,l),h(),g(),f(j,k)}}),a.$watch("years.to",function(){if(console.log("hey, myVar has changed!",this),this.last){var a=i;if(i=this.last,Number(a)==Number(i))return;console.log("year changed requesting pics ",a,i),g(),h(),f(j,k)}}),a.$watch("months.to",function(){if(console.log("hey, myVar has changed!",this),this.last){var a=n;if(n=this.last,Number(n)===Number(a))return;g(),h(),f(j,k)}}),a.$watch("months.from",function(){if(console.log("hey, myVar has changed!",this),this.last){var a=m;if(m=this.last,Number(m)===Number(a))return;g(),h(),console.log("hey, myVar has changed! from to ",j),f(j,k)}}),c.then(function(a){console.log("maps ready",a)})}]),angular.module("photomapApp").factory("Pictures",["$http","$location","$cookieStore",function(a,b,c){function d(){var a={},b=c.get("session");return b&&(a["x-session-id"]=b.sessionId,a["x-user-id"]=b.userId),a}function e(a,c,d){401===c?(d("unauthorised"),b.url("/login")):a&&(console.error(a),d(a))}return{getYearRange:function(b){a({method:"get",url:ServiceConfig.api+"pictures/range",headers:d()}).success(function(a){b(void 0,a)}).error(function(a,c){e(a,c,b)})},getPicturesInRange:function(b,c,f){a({method:"get",url:ServiceConfig.api+"pictures/"+b+"/"+c,headers:d()}).success(function(a){f(void 0,a)}).error(function(a,b){e(a,b,f)})}}}]),angular.module("photomapApp").controller("UploadCtrl",["$scope","$upload","$cookieStore",function(a,b,c){var d={},e=c.get("session");e&&(d["x-session-id"]=e.sessionId,d["x-user-id"]=e.userId),a.onFileSelect=function(c){a.progress=0,a.$apply();var e=new SockJS(ServiceConfig.api+"updates"),f=Stomp.over(e);f.connect({},function(a){console.log("Connected: "+a)});for(var g=0;g<c.length;g++){var h=c[g];a.upload=b.upload({url:ServiceConfig.api+"pictures/upload",headers:d,data:{myObj:a.myModelObj},file:h}).progress(function(b){a.progress=parseInt(70*b.loaded/b.total),70==a.progress&&(a.progressMessage="upload finished +"+a.progress+" complete")}).success(function(b){f.subscribe("/queue/jobupdate/"+b.key,function(b){var c=JSON.parse(b.body);("complete"===c.Status||"error"===c.Status)&&e.close(),console.log("message ",c.Message),a.progress+=10,a.progressMessage=c.Message+" "+a.progress,a.$apply()}),f.send("/jobs/update/"+b.key,{},JSON.stringify({name:name}))}).error(function(){})}}}]),angular.module("photomapApp").controller("RegisterCtrl",["$scope","userService",function(a,b){function c(b,c){a.showMessage=!0,a.messageTitle=b,a.message=c}a.messageClose=function(){a.showMessage=!1},a.registerUser=function(){b.register(this.username,this.email,this.password,function(b){b?c("Registration Failed",b.message):(a.success=!0,c("Success! ","Check your email (no email actually sent yet)"))})}}]),angular.module("photomapApp").controller("LoginCtrl",["$scope","$location","$cookieStore","userService",function(a,b,c,d){function e(b,c){a.showMessage=!0,a.messageTitle=b,a.message=c}a.messageClose=function(){a.showMessage=!1},a.loginUser=function(){d.login(this.email,this.password,function(a){a&&401===a?e("Login Failed","Invalid username/password"):b.url("/home")})}}]),angular.module("photomapApp").service("userService",["$http","$location","$cookieStore",function(a,b,c){function d(){var a={},b=c.get("session");return b&&(a["x-auth"]=b.sessionId,a["x-user"]=b.userId),a}return a.defaults.headers.withCredentials=!0,{getUser:function(c,e){a({method:"get",url:ServiceConfig.api+"user/"+c,headers:d()}).success(function(a){console.log("all good ",a),e(void 0,a)}).error(function(a,c){console.log(a,c),401===c?b.url("/login"):e(a)})},register:function(b,c,d,e){console.log("u ",b,"e ",c,"p ",d),a({method:"post",url:ServiceConfig.api+"user/register",data:{userName:b,email:c,password:d}}).success(function(a){console.log("registered ok ",a),e()}).error(function(a,b){console.log(a,b),e({status:b,message:a})})},login:function(b,d,e){var f={email:b,password:d};console.log("login data ",f),a({method:"post",url:ServiceConfig.api+"user/login",data:f}).success(function(a){c.put("session",a),e(void 0,a)}).error(function(a,b){e(b)})}}}]),angular.module("photomapApp").controller("PicturesCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]);